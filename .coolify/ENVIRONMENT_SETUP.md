# Coolify Environment Setup Guide

This guide provides comprehensive instructions for setting up environment variables and secrets management for the n8n-clone application deployment on Coolify.

## üìã Overview

The environment configuration consists of several categories:
- **Secrets**: Sensitive data like passwords and encryption keys
- **Domain Configuration**: URLs and domain settings
- **Database Configuration**: PostgreSQL and Redis settings
- **Application Configuration**: Runtime settings and features
- **Security Configuration**: Authentication and security policies

## üöÄ Quick Start

### Option 1: Automated Setup (Recommended)

Run the automated setup script:

```bash
# For Linux/macOS
./.coolify/setup-environment.sh production

# For Windows PowerShell
.\.coolify\setup-environment.ps1 production
```

This will:
1. Generate secure secrets automatically
2. Prompt for domain configuration
3. Create environment files
4. Generate Coolify import configuration
5. Provide step-by-step deployment instructions

### Option 2: Manual Configuration

Follow the detailed steps below to configure each component manually.

## üîê Secrets Management

### Required Secrets

These secrets must be configured in Coolify's Secrets Management:

| Secret Name | Description | Length | Generation Method |
|-------------|-------------|---------|-------------------|
| `POSTGRES_PASSWORD` | Database password | 32 chars | Secure password with mixed case, numbers, symbols |
| `JWT_SECRET` | JWT signing key | 64 chars | Random alphanumeric + symbols |
| `SESSION_SECRET` | Session encryption | 32 chars | Random alphanumeric + symbols |
| `ENCRYPTION_KEY` | Data encryption | 32 chars | Hexadecimal string |
| `WEBHOOK_SIGNING_SECRET` | Webhook security | 48 chars | Random alphanumeric |

### Secret Generation Examples

```bash
# Generate POSTGRES_PASSWORD (32 chars with complexity)
openssl rand -base64 48 | tr -d "=+/" | cut -c1-32

# Generate JWT_SECRET (64 chars)
openssl rand -base64 96 | tr -d "=+/" | cut -c1-64

# Generate SESSION_SECRET (32 chars)
openssl rand -base64 48 | tr -d "=+/" | cut -c1-32

# Generate ENCRYPTION_KEY (32 hex chars)
openssl rand -hex 16

# Generate WEBHOOK_SIGNING_SECRET (48 chars)
openssl rand -base64 72 | tr -d "=+/" | cut -c1-48
```

### Security Requirements

- **Minimum Length**: All secrets must meet minimum length requirements
- **Complexity**: Passwords must include uppercase, lowercase, numbers, and symbols
- **Uniqueness**: Each secret must be unique across environments
- **Rotation**: Production secrets should be rotated every 90 days

## üåê Domain Configuration

### Required Domain Variables

Configure these in Coolify Environment Variables:

| Variable | Description | Example | Required |
|----------|-------------|---------|----------|
| `FRONTEND_DOMAIN` | Frontend domain | `yourdomain.com` | Yes |
| `BACKEND_DOMAIN` | API domain | `api.yourdomain.com` | Yes |
| `CORS_ORIGIN` | CORS allowed origin | `https://yourdomain.com` | Yes |
| `VITE_API_URL` | Frontend API URL | `https://api.yourdomain.com` | Yes |
| `WEBHOOK_URL` | Webhook base URL | `https://yourdomain.com` | Yes |

### Domain Consistency Rules

- `CORS_ORIGIN` must match `https://${FRONTEND_DOMAIN}`
- `VITE_API_URL` must match `https://${BACKEND_DOMAIN}`
- `WEBHOOK_URL` should typically match `https://${FRONTEND_DOMAIN}`
- All production URLs must use HTTPS

## üóÑÔ∏è Database Configuration

### PostgreSQL Settings

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `POSTGRES_DB` | Database name | `n8n_clone` | No |
| `POSTGRES_USER` | Database user | `postgres` | No |
| `POSTGRES_PASSWORD` | Database password | (generated) | Yes |

### Computed Database Variables

These are automatically generated by Coolify:

```bash
DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
```

### Redis Settings

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `REDIS_URL` | Redis connection | `redis://redis:6379` | Auto-generated |

## ‚öôÔ∏è Application Configuration

### Core Settings

| Variable | Description | Default | Options |
|----------|-------------|---------|---------|
| `NODE_ENV` | Environment | `production` | `production`, `staging`, `development` |
| `LOG_LEVEL` | Logging level | `info` | `error`, `warn`, `info`, `debug` |
| `PORT` | Backend port | `4000` | 1024-65535 |
| `FRONTEND_PORT` | Frontend port | `3000` | 1024-65535 |

### Security Settings

| Variable | Description | Default | Notes |
|----------|-------------|---------|-------|
| `JWT_EXPIRES_IN` | Token expiration | `7d` | Format: `1h`, `1d`, `7d` |
| `BCRYPT_ROUNDS` | Password hashing | `12` | Range: 10-15 |
| `SESSION_COOKIE_SECURE` | Secure cookies | `true` | Always true in production |
| `SESSION_COOKIE_HTTP_ONLY` | HTTP-only cookies | `true` | Security requirement |
| `SESSION_COOKIE_SAME_SITE` | SameSite policy | `strict` | `strict`, `lax`, `none` |

## üìÅ Environment Files

### File Structure

```
.coolify/
‚îú‚îÄ‚îÄ environment-config.json          # Master configuration
‚îú‚îÄ‚îÄ database-config.json            # Database settings
‚îú‚îÄ‚îÄ secrets-config.json             # Secrets management
‚îú‚îÄ‚îÄ environment.json                # Coolify integration
‚îú‚îÄ‚îÄ setup-environment.sh           # Linux/macOS setup script
‚îú‚îÄ‚îÄ setup-environment.ps1          # Windows PowerShell script
‚îú‚îÄ‚îÄ validate-environment.js         # Validation script
‚îú‚îÄ‚îÄ .env.coolify.production        # Production template
‚îú‚îÄ‚îÄ .env.coolify.staging           # Staging template
‚îî‚îÄ‚îÄ ENVIRONMENT_SETUP.md           # This guide
```

### Environment Templates

Use the provided templates as starting points:

- **Production**: `.env.coolify.production`
- **Staging**: `.env.coolify.staging`

## üîç Validation

### Automated Validation

Run the validation script to check your configuration:

```bash
node .coolify/validate-environment.js production
```

This validates:
- Required variables are set
- Secret strength and complexity
- Domain format and consistency
- Database configuration
- Security settings
- Coolify-specific configuration

### Manual Validation Checklist

- [ ] All required secrets are generated and stored securely
- [ ] Domain names are valid and consistent
- [ ] Database credentials are properly configured
- [ ] SSL is enabled for all production domains
- [ ] Security settings meet production requirements
- [ ] Environment-specific settings are correct

## üöÄ Deployment Steps

### 1. Prepare Configuration

1. Run setup script or configure manually
2. Validate configuration with validation script
3. Review generated files

### 2. Configure Coolify Project

1. Create new project in Coolify dashboard
2. Connect Git repository
3. Import environment configuration

### 3. Set Up Secrets

1. Navigate to Secrets Management in Coolify
2. Add all required secrets from generated configuration
3. Verify secret values are correctly set

### 4. Configure Environment Variables

1. Add all non-secret environment variables
2. Verify computed variables are correctly generated
3. Test variable substitution

### 5. Deploy Services

Deploy in this order:
1. PostgreSQL database
2. Redis cache
3. Backend API
4. Frontend application

### 6. Configure Domains and SSL

1. Set up custom domains for frontend and backend
2. Enable SSL certificates (Let's Encrypt)
3. Configure redirects and security headers

### 7. Verify Deployment

1. Check service health endpoints
2. Test database connectivity
3. Verify API functionality
4. Test frontend-backend communication

## üîß Troubleshooting

### Common Issues

**Secret Generation Fails**
- Ensure OpenSSL is installed
- Check character set requirements
- Verify minimum length requirements

**Domain Validation Errors**
- Check domain format (no protocol in domain variables)
- Verify DNS configuration
- Ensure SSL certificates are valid

**Database Connection Issues**
- Verify PostgreSQL service is running
- Check database credentials
- Confirm network connectivity between services

**Redis Connection Problems**
- Ensure Redis service is healthy
- Check Redis URL format
- Verify network access

### Debug Commands

```bash
# Check environment variables
env | grep -E "(POSTGRES|JWT|SESSION|CORS|VITE)"

# Test database connection
psql $DATABASE_URL -c "SELECT 1;"

# Test Redis connection
redis-cli -u $REDIS_URL ping

# Validate configuration
node .coolify/validate-environment.js
```

## üìö Additional Resources

- [Coolify Documentation](https://coolify.io/docs)
- [Environment Variable Best Practices](https://12factor.net/config)
- [Security Configuration Guide](./SECURITY.md)
- [Deployment Troubleshooting](./TROUBLESHOOTING.md)

## üîí Security Considerations

- Never commit secrets to version control
- Use different secrets for each environment
- Rotate secrets regularly (90 days for production)
- Monitor secret access and usage
- Implement proper backup and recovery procedures
- Follow principle of least privilege for secret access

## üìû Support

If you encounter issues:

1. Check the troubleshooting section above
2. Validate your configuration with the validation script
3. Review Coolify logs for deployment errors
4. Consult the project documentation
5. Create an issue with detailed error information